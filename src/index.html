<!DOCTYPE html>
<html>
<head>
	<title>Pasar lista</title>

	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">

	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script type="text/javascript">

	var filtroActivo;

	function activarFiltro(filtro) {
		filtroActivo = filtro;

		var texto;
		if(filtro == 'cn') {
			$('#busquedaAlumno').prop('disabled', false);
			texto = "Nombre completo: ";
		} else if(filtro == 'info') {
			$('#busquedaAlumno').prop('disabled', false);
			texto = "Grado: ";
		} else if(filtro == 'uid') {
			$('#busquedaAlumno').prop('disabled', false);
			texto = "Nombre usuario: ";
		} else if(filtro == "reset") {
			$('#busquedaAlumno').prop('disabled', true);
			texto = "Filtro:  ";
		}

		$('#busquedaAlumno').val('');
		$('#filtro-selector').html(texto+'<span class="caret"></span>');
	}

	function imprimirTabla(idTabla, json) {

		var tabla = '<table class="table table-striped">';

		tabla += '<thead>';
		tabla += '<tr>';
		tabla += '<th># Usuario</th>';
		tabla += '<th>Nombre completo</th>';
		tabla += '<th>Directorio personal</th>';
		tabla += '<th>Grado</th>';
		tabla += '<th>Nombre de usuario</th>';
		tabla += '</tr>';
		tabla += '</thead>';
		tabla += '<tbody>';

			
		for(var k = 0; k < json.length; k++) {
			var alumno = json[k];

			tabla += '<tr>';
			tabla += '<td>'+alumno.uidNumber+'</td>';
			tabla += '<td>'+alumno.cn+'</td>';
			tabla += '<td>'+alumno.homeDirectory+'</td>';
			tabla += '<td>'+alumno.info+'</td>';
			tabla += '<td>'+alumno.uid+'</td>';
			tabla += '</tr>';
		}

		tabla += '</tbody>';
		tabla += '</table>';

		$(tabla).appendTo(idTabla);
	}

	function buscarConFiltro(val, cb) {
		var exec = require('child_process').exec;
		var cmd = 'ldapsearch -xLLL -b "ou=People,dc=primariadigital,dc=local" ';
		cmd += filtroActivo+'=*'+val+'* ';
		cmd += 'cn homeDirectory info uid uidNumber';
		cmd += '| grep -v dn';

		exec(cmd, function(error, stdout, stderr) {
			cb(stdout);
		});
	}

	function buscarTodos(cb) {

		var exec = require('child_process').exec;
		var cmd = 'ldapsearch -xLLL -b ou=People,dc=primariadigital,dc=local cn homeDirectory info uid uidNumber | grep -v dn';

		exec(cmd, function(error, stdout, stderr) {
			cb(stdout);
		});
	}

	function ldap2json(ldapstring) {

		var json = [];
		var jsonIter = 0;

		var strings = ldapstring.split('\n');

		for(var k = 0; k < strings.length; k++){
			var s = strings[k];
			if(!s) {
				continue;
			}

			var lv = s.split(':');
			var llave = lv[0].trim();
			var valor = lv[1].trim();

			if(llave == 'cn') {
				jsonIter = json.push({}) - 1;
			}

			json[jsonIter][llave] = valor;
		}

		return json;
	}

	function habilitarGui(tipo) {

		$('#inicio').hide();

		$('#modo-'+tipo).show();
		if(tipo == 'visualizacion') {
			var exec = require('child_process').exec;

			$('#busquedaAlumno').keypress(function(e) {
				if(e.which == 13) {
					var val = $('#busquedaAlumno').val();
					buscarConFiltro(val, function(ret) {
						$('#tabla-cont').empty();
						var json = ldap2json(ret);

						imprimirTabla('#tabla-cont', json);
					});
				}
			});


			buscarTodos(function(ret) {
				$('#tabla-cont').empty();
				var json = ldap2json(ret);

				imprimirTabla('#tabla-cont', json);
			});

		} else if (tipo == 'edicion') {

		}
	}

	$(function() {

		$('#btnVer').on('click', function() {
			habilitarGui('visualizacion');
		});

		$('#btnEditar').on('click', function() {
			habilitarGui('edicion');
		});
		
	});

	</script>

</head>
<body>

	<h1>Matr&iacute;cula de alumnos</h1>
	<br>
	<div id="inicio">

		<div class="btn-group" role="group" aria-label="...">
			<button type="button" class="btn btn-danger" id="btnVer">Visualizar</button>
			<button type="button" class="btn btn-danger" id="btnEditar">Editar</button>
		</div>
	</div>

	<div id="modo-visualizacion" style="display:none;">
		<div class="input-group input-group-lg">
 			<div class="input-group-btn">
				<button type="button" class="btn btn-default dropdown-toggle" id="filtro-selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Filtro: <span class="caret"></span></button>
				<ul class="dropdown-menu">
					<li><a onclick="activarFiltro('reset');">Reset</a></li>
					<li role="separator" class="divider"></li>
					<li><a onclick="activarFiltro('cn');">Nombre</a></li>
					<li><a onclick="activarFiltro('info');">Grado</a></li>
					<li><a onclick="activarFiltro('uid');">Nombre de usuario</a></li>
        			</ul>
			</div>
			<input id="busquedaAlumno" type="text" class="form-control" placeholder="Buscar..." aria-describedby="sizing-addon1" autofocus disabled>
		</div>
	</div>

	<div id="modo-edicion" style="display:none;">

	</div>
	<br>
	<div id="tabla-cont">
	</div>

</body>
</html>

